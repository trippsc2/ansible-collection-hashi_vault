---
DOCUMENTATION:
  module: vault_kv2_secret_engine
  version_added: 1.0.0
  author:
    - Jim Tarpley (@trippsc2)
  short_description: Configures a KV version 2 secret engine in HashiCorp Vault.
  description:
    - Ensures a L(KV version 2 secret engine,https://hvac.readthedocs.io/en/stable/usage/secrets_engines/kv_v2.html) is configured as expected in HashiCorp Vault.
  extends_documentation_fragment:
    - trippsc2.hashi_vault.attributes
    - trippsc2.hashi_vault.auth
    - trippsc2.hashi_vault.connection
    - trippsc2.hashi_vault.engine_mount
    - trippsc2.hashi_vault.requirements
    - trippsc2.hashi_vault.secret_engine
  options:
    max_versions:
      type: int
      required: false
      description:
        - The maximum number of versions to keep for each secret.
        - If set to V(0), the 10 versions will be kept.
        - If not provided, this defaults to V(10) on new secret engines.
    cas_required:
      type: bool
      required: false
      description:
        - Whether to require the use of a Check-And-Set (CAS) parameter for write operations.
    delete_version_after:
      type: str
      required: false
      description:
        - The duration after which a version is deleted.
        - This value can be provided as a duration string, such as V(72h), or as an number of seconds.
        - If set to V(0), versions will not be deleted.
        - If not provided, this will default to V(0) on new secret engines.
EXAMPLES: |
  - name: Create a new KV version 2 secret engine
    trippsc2.hashi_vault.vault_kv2_secret_engine:
      url: https://vault:8201
      auth_method: userpass
      username: '{{ user }}'
      password: '{{ passwd }}'
      engine_mount_point: secret
      state: present

  - name: Remove a KV version 2 secret engine
    trippsc2.hashi_vault.vault_kv2_secret_engine:
      url: https://vault:8201
      auth_method: userpass
      username: '{{ user }}'
      password: '{{ passwd }}'
      engine_mount_point: secret
      state: absent

RETURN:
  config:
    type: dict
    returned: O(state=present)
    description:
      - The configuration of the secret engine.
    sample:
      description: 'The KV2 secret engine.'
      default_lease_ttl: 2678400
      max_lease_ttl: 2678400
      audit_non_hmac_request_keys: []
      audit_non_hmac_response_keys: []
      listing_visibility: unauth
      passthrough_request_headers: []
      max_versions: 10
      cas_required: false
      delete_version_after: 0
    contains:
      description:
        type: str
        description:
          - The description of the secret engine.
      default_lease_ttl:
        type: int
        description:
          - The default lease TTL of the secret engine in seconds.
      max_lease_ttl:
        type: int
        description:
          - The maximum lease TTL of the secret engine in seconds.
      audit_non_hmac_request_keys:
        type: list
        elements: str
        description:
          - The list of non-HMAC request keys to audit.
      audit_non_hmac_response_keys:
        type: list
        elements: str
        description:
          - The list of non-HMAC response keys to audit.
      listing_visibility:
        type: str
        description:
          - The listing visibility of the secret engine.
      passthrough_request_headers:
        type: list
        elements: str
        description:
          - The list of request headers to pass through.
      max_versions:
        type: int
        description:
          - The maximum number of versions to keep for each secret.
      cas_required:
        type: bool
        description:
          - Whether to require the use of a Check-And-Set (CAS) parameter for write operations.
      delete_version_after:
        type: str
        description:
          - The duration after which a version is deleted.
  prev_config:
    description:
      - The previous configuration of the secret engine.
    type: dict
    returned: changed
    sample:
      description: 'The KV2 secret engine.'
      default_lease_ttl: 2678400
      max_lease_ttl: 2678400
      audit_non_hmac_request_keys: []
      audit_non_hmac_response_keys: []
      listing_visibility: unauth
      passthrough_request_headers: []
      max_versions: 10
      cas_required: false
      delete_version_after: 0
    contains:
      description:
        type: str
        description:
          - The description of the secret engine.
      default_lease_ttl:
        type: int
        description:
          - The default lease TTL of the secret engine in seconds.
      max_lease_ttl:
        type: int
        description:
          - The maximum lease TTL of the secret engine in seconds.
      audit_non_hmac_request_keys:
        type: list
        elements: str
        description:
          - The list of non-HMAC request keys to audit.
      audit_non_hmac_response_keys:
        type: list
        elements: str
        description:
          - The list of non-HMAC response keys to audit.
      listing_visibility:
        type: str
        description:
          - The listing visibility of the secret engine.
      passthrough_request_headers:
        type: list
        elements: str
        description:
          - The list of request headers to pass through.
      max_versions:
        type: int
        description:
          - The maximum number of versions to keep for each secret.
      cas_required:
        type: bool
        description:
          - Whether to require the use of a Check-And-Set (CAS) parameter for write operations.
      delete_version_after:
        type: str
        description:
          - The duration after which a version is deleted.
